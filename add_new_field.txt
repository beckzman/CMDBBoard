# How to Add a New Field to the CMDB
# This document tracks the process and potential bugs when adding new columns.

## Checklist

### 1. Database Layer
[ ] Add column to `ConfigurationItem` class in `backend/app/db/models.py`.
    Example: `service_provider = Column(String(255))`
[ ] Create and run a migration script to update the actual database table.
    See `backend/scripts/migrate_service_provider.py` (to be created) for reference.

### 2. Backend API & Schemas
[ ] Update `CIBase`, `CICreate`, `CIUpdate`, `CIResponse` in `backend/app/schemas.py`.
    Add `service_provider: Optional[str] = None`.
[ ] Update `ExportService` in `backend/app/services/export_service.py` to include the field in CSV/Excel.

### 3. Import Logic
[ ] Check `backend/app/core/import_engine.py`.
    - Update `_create_ci` dictionary to include the new field.
    - Update `_update_ci` logic if special handling is needed (usually handled dynamically by `setattr`).
    - Update `field_mapper.py` (if hardcoded mapping exists) or ensure the config mapping (DB) covers it.
    - Note: SharePoint field names often have `_x0020_` for spaces (e.g., `Service_x0020_Provider`).

### 4. Frontend
[ ] Update `ConfigurationItem` interface in `frontend/src/api/client.ts`.
[ ] Update `ConfigurationItems.tsx`:
    - Add to `AVAILABLE_COLUMNS` list (essential!).
    - Add to `filterableColumns` list if you want it in the filter dropdown.
    - Update `renderCellContent` switch-case if it needs special formatting (e.g., date, badge, tooltip).
[ ] Update `AddCIModal.tsx`:
    - Add to `formData` initialized state.
    - Add to `useEffect` hooks (for populating on edit, and resetting on close).
    - Add `<input>` field to the JSX return.

## Known Bugs / Gotchas
- **Column Visibility**: When you add a new column to `AVAILABLE_COLUMNS`, it **WILL NOT** appear automatically for users who have visited the page before.
    - *Reason*: `visibleColumns` preference is saved in `localStorage`.
    - *Fix*: Users must click the "Columns" button and manually toggle the new column ON.
- **Import Mapping**: SharePoint internal names are tricky (e.g. `_x0020_` vs space). Always check the raw import log.
- **Filter**: If filter dropdown shows "Option", ensure the backend `get_distinct_attribute_values` allows the new field (whitelist).
- **Sorting**: Ensure the new column key matches the backend model attribute exactly.

